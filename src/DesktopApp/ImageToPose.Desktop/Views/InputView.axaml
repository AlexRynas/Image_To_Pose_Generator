<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ImageToPose.Desktop.ViewModels"
             xmlns:models="using:ImageToPose.Core.Models"
             mc:Ignorable="d" d:DesignWidth="1024" d:DesignHeight="700"
             x:Class="ImageToPose.Desktop.Views.InputView"
             x:DataType="vm:InputViewModel">
    
    <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
        <DockPanel Margin="24">
            <!-- Right side: Mode and Estimates -->
            <StackPanel DockPanel.Dock="Right" Width="320" Spacing="12">
                <Border BorderBrush="{DynamicResource Brush.Border}" BorderThickness="1" CornerRadius="6" Padding="10">
                    <StackPanel Spacing="8">
                        <TextBlock Text="Operating Mode" FontWeight="SemiBold"/>
                        <ComboBox SelectedItem="{Binding ModeVM.Mode}">
                            <ComboBox.Items>
                                <models:OperatingMode>Budget</models:OperatingMode>
                                <models:OperatingMode>Balanced</models:OperatingMode>
                                <models:OperatingMode>Quality</models:OperatingMode>
                            </ComboBox.Items>
                        </ComboBox>
                        <TextBlock Text="{Binding ModeVM.ModeDescription}" FontSize="12" Foreground="{DynamicResource Brush.TextMuted}" TextWrapping="Wrap"/>
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="Using:"/>
                            <TextBlock Text="{Binding ModeVM.ResolvedModelId}" FontWeight="SemiBold"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <Button Content="OpenAI Pricing" Command="{Binding ModeVM.RefreshPricingCommand}" HorizontalAlignment="Left"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <Border BorderBrush="{DynamicResource Brush.Border}" BorderThickness="1" CornerRadius="6" Padding="10">
                    <StackPanel Spacing="6">
                        <TextBlock Text="Estimates (≈ tokens → USD)" FontWeight="SemiBold"/>
                        <StackPanel Spacing="2">
                            <TextBlock Text="Step 1 (Vision)" FontWeight="SemiBold"/>
                            <TextBlock FontSize="12">
                                <Run Text="Input: "/>
                                <Run Text="{Binding ModeVM.VisionEstimate.InputTokens}"/>
                                <Run Text=" tokens"/>
                            </TextBlock>
                            <TextBlock FontSize="12">
                                <Run Text="Output: "/>
                                <Run Text="{Binding ModeVM.VisionEstimate.OutputTokens}"/>
                                <Run Text=" tokens"/>
                            </TextBlock>
                            <TextBlock FontSize="12">
                                <Run Text="≈ $"/>
                                <Run Text="{Binding ModeVM.VisionEstimate.TotalUsd, StringFormat={}{0:F6}}"/>
                            </TextBlock>
                        </StackPanel>
                        <Separator/>
                        <StackPanel Spacing="2">
                            <TextBlock Text="Step 2 (Text)" FontWeight="SemiBold"/>
                            <TextBlock FontSize="12">
                                <Run Text="Input: "/>
                                <Run Text="{Binding ModeVM.TextEstimate.InputTokens}"/>
                                <Run Text=" tokens"/>
                            </TextBlock>
                            <TextBlock FontSize="12">
                                <Run Text="Output: "/>
                                <Run Text="{Binding ModeVM.TextEstimate.OutputTokens}"/>
                                <Run Text=" tokens"/>
                            </TextBlock>
                            <TextBlock FontSize="12">
                                <Run Text="≈ $"/>
                                <Run Text="{Binding ModeVM.TextEstimate.TotalUsd, StringFormat={}{0:F6}}"/>
                            </TextBlock>
                        </StackPanel>
                        <TextBlock Text="Estimates only; see OpenAI billing for exacts." FontSize="11" Foreground="{DynamicResource Brush.TextMuted}" TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Left/main content -->
            <StackPanel MaxWidth="700" Margin="20" Spacing="20">
                <TextBlock Text="Input Image and Pose Description" 
                           FontSize="28" 
                           FontWeight="Bold" 
                           Margin="0,0,0,10"/>
                
                <TextBlock TextWrapping="Wrap" FontSize="14">
                    Select a reference image and provide a rough description of the pose. The AI will analyze both to create a detailed pose description.
                </TextBlock>
                
                <!-- Image Selection -->
                <StackPanel Spacing="10">
                    <TextBlock Text="Reference Image:" FontWeight="SemiBold" FontSize="16"/>
                    <Button Content="Select Image..." 
                            Command="{Binding SelectImageCommand}"
                            HorizontalAlignment="Left"
                            Padding="20,10"/>
                    
                    <TextBlock Text="{Binding ImagePath}" 
                               TextWrapping="Wrap" 
                               FontSize="12" 
                               Foreground="{DynamicResource Brush.TextMuted}"
                               IsVisible="{Binding ImagePath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                    
                    <!-- Image Preview -->
                    <Border BorderBrush="{DynamicResource Brush.Border}" 
                            Background="{DynamicResource Brush.Surface}"
                            BorderThickness="1" 
                            CornerRadius="8" 
                            MaxWidth="400" 
                            MaxHeight="400"
                            HorizontalAlignment="Left"
                            IsVisible="{Binding ImagePreview, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <Image Source="{Binding ImagePreview}" 
                               Stretch="Uniform"/>
                    </Border>
                </StackPanel>
                
                <!-- Pose Description -->
                <StackPanel Spacing="10">
                    <TextBlock Text="Rough Pose Description:" FontWeight="SemiBold" FontSize="16"/>
                    <TextBlock TextWrapping="Wrap" FontSize="13" Foreground="{DynamicResource Brush.TextMuted}">
                        Provide details about the pose - e.g., "Standing with left hand raised, right hand on hip, weight on right leg"
                    </TextBlock>
                    <TextBox Text="{Binding RoughPoseText}" 
                             AcceptsReturn="True" 
                             TextWrapping="Wrap" 
                             MinHeight="150"
                             Watermark="Enter pose description here..."/>
                </StackPanel>
                
                <!-- Error Message -->
                <Border Background="{DynamicResource Brush.Danger}" 
                        BorderBrush="{DynamicResource Brush.Border}" 
                        BorderThickness="1" 
                        CornerRadius="8" 
                        Padding="12"
                        IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding ErrorMessage}" 
                               TextWrapping="Wrap" 
                               Foreground="White"/>
                </Border>
                
                <!-- Processing Indicator -->
                <StackPanel Orientation="Horizontal" Spacing="10" IsVisible="{Binding IsProcessing}">
                    <ProgressBar IsIndeterminate="True" Width="300" Height="4"/>
                    <TextBlock Text="Processing with AI..." VerticalAlignment="Center"/>
                </StackPanel>
                
                <Button Content="Process Photo and Pose Description" 
                        Command="{Binding ProcessImageAndPoseCommand}"
                        IsEnabled="{Binding CanProcessImageAndPose}"
                        HorizontalAlignment="Center"
                        FontSize="16"
                        Padding="30,12"
                        Margin="0,20,0,0"/>
            </StackPanel>
        </DockPanel>
    </ScrollViewer>
</UserControl>
